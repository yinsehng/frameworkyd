<%@ page language="java" import="java.util.*" pageEncoding="utf-8" contentType="text/html; charset=utf-8"%>
<%  
	String path = request.getContextPath();
	String basePath = request.getScheme()+"://"+request.getServerName()+":"+request.getServerPort()+path+"/";
	//获取数据
	String diseasesOrder_json = (String)request.getAttribute("diseasesOrder_json");
%>
<!-- 病种信息排行，分为转入转出 -->
<div style="width: 100%; height: 100%;">
    <!-- 为ECharts准备一个具备大小（宽高）的Dom -->
    <div id="diseases_order" style="height:100%;width:100%"></div>
    <script type="text/javascript">
    // 基于准备好的dom，初始化echarts图表
    var diseasesOrder_json = <%= diseasesOrder_json%>;
    var myChartDiseasesOrder = echarts.init(document.getElementById('diseases_order'));
    flushDiseasesOrder(diseasesOrder_json);
    //此处调用定时任务
    $(document).ready(function () {
    	setInterval("getDiseasesOrderByAjax()", 100000);
    });
    //定义getDiseasesOrderByAjax函数
    function getDiseasesOrderByAjax() {
    	if(autoflag!=1){
			return;
		}
    	$.ajax( {  
    	    url:'<%=basePath %>ActionServlet?method=diseasesOrderAction&ajax=true',
    	    data:{},  
    	    type:'GET',
    	    cache:false, 
    	    dataType:'json',
    	    success:function(resultmodel) {
    	        if(resultmodel.code =="200" ){
    	        	//更新数据
    	            flushDiseasesOrder(resultmodel);
    	        }
    	     },
    	     error : function() {  
    	         if (resultmodel.code =="500"){
    	        	  alert(resultmodel.message);
    	         }
    	     }
    	});
    }
   function flushDiseasesOrder(diseasesOrder_json) {
    	
        var data_primary = diseasesOrder_json.yAxis.转入;
        var data_primary2 = diseasesOrder_json.yAxis.转出;
        
        var data = new Array();
        var data2 = new Array();
        
        for (var i = 0; i < data_primary.length; i++) {
        	if (data_primary[i].length >= 2) {
        		data[i] = data_primary[i].substr(0,3);
        	}
        }
        for (var i = 0; i < data_primary2.length; i++) {
        	if (data_primary2[i].length >= 2) {
        		data2[i] = data_primary2[i].substr(0,3);
        	}
        }
        
        option = {
    	title: {
            text: diseasesOrder_json.title,
            sublink: 'http://www.neusoft.com',
            left: 'center',
            textStyle: {
                color: '#fff'
            }
        },
    	
        tooltip : {

            formatter: function (params,ticket,callback) {
                var res = '';
                var dataprimary;
                var qufan = -1;
                if (params.name != '') {
                        if (params.value > 0) {
                            var dataprimary = data_primary;
                            qufan = 1;
                        } else {
                            dataprimary = data_primary2;
                        }
                        res +=  params.seriesName + ':';
                        var dataIndex = params.dataIndex;
                        
                        res += '<br/>' + dataprimary[dataIndex];
                        
                }
                
                res += '<br/>' + (params.value)*qufan;
                
                setTimeout(function (){
                    // 仅为了模拟异步回调
                    callback(ticket, res);
                }, 0)
                return 'loading';
            }
        },
       
        toolbox: {
            show : true,
            feature : {
            
            }
        },
        calculable : true,
        xAxis : [
    	
            {
                type : 'value',
                boundaryGap : [0, 0.01],
                
    			 axisLine:{
                    lineStyle:{
                        color:'#fff',
                    }
                }
    			
            },
             {
                type : 'value',
                boundaryGap : [0, 0.01],
                axisLabel : {
                    formatter: function(v){
                        return - v;
                    }
                },
                 axisLine:{
                    lineStyle:{
                        color:'#fff',
                      
                    }
                }
                
            }
        ],
        yAxis : [
            {
                type : 'category',
                data : data,
    			axisLabel:{
                  textStyle:{
                    color:"#fff", //刻度颜色
                    fontSize:2,
    				
                }
              },
    		  axisLine:{
                    lineStyle:{
                        color:'#fff',
                        
                    }
                }
            },
            {
                type : 'category',
                data : data2,
                axisLabel:{
                  textStyle:{
                    color:"#fff", //刻度颜色
                    fontSize:2,
                    
                }
              },
              axisLine:{
                    lineStyle:{
                        color:'#fff',
                        
                    }
                }
            }
    		
        ]
    	,
        series : [
           {
                xAxisIndex:'0',
                itemStyle: {normal: {areaStyle: {type: 'default'}}},
                name:'转入',
                type:'bar',
                barWidth : 10,
                data:diseasesOrder_json.series.转入,
                itemStyle:{
        							normal:{
        								color:new echarts.graphic.LinearGradient(0, 0, 0, 1, [{
					                        offset: 0,
					                        color: '#e25041'
					                    }, {
					                        offset: 1,
					                        color: '#ffb275'
					                    }]),
        							}
        						}
            },
            {
                xAxisIndex:'1',
                name:'转出',
                type:'bar',
    			barWidth : 10,
    			itemStyle:{
				normal:{
 					 color:new echarts.graphic.LinearGradient(0, 0, 0, 1, [{
                      offset: 0,
                      color: '#00c7ab'
                  }, {
                      offset: 1,
                      color: '#75e1c2'
                  }]),
 							}
 						},
                data: (function(){
                    var data = diseasesOrder_json.series.转出;
                    var len = data.length;
                    while(len--) {
                        data[len] *= -1;
                    }
                    return data;
                })()
                
            }
        ]
    	
    };       
          // 为echarts对象加载数据 
          myChartDiseasesOrder.setOption(option); 
    }
    
    </script>
</div>
